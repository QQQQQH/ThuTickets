# 项目使用帮助


## 建立数据库
在MySQL中登录账号：root，密码：12345678。

登录数据库：
```sql
mysql -u root -p
```
用以下命令建立数据库：
```sql
CREATE DATABASE thutickets;
```
进入数据库：
``` sql
USE thutickets;
```
并添加数据表：
``` sql
CREATE TABLE `admin`  (
  `admin_username` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'admin_username',
  `admin_password` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'admin_password',
  `create_time` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `last_visit_time` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT '最后登录时间',
  PRIMARY KEY (`admin_username`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '管理员信息' ROW_FORMAT = Dynamic;
```

``` sql
CREATE TABLE `user`  (
  `openid` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'openid',
  `session_key` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'session_key',
  `status_key` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'status_key',
  `studentid` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL COMMENT 'studentid',
  `nick_name` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '昵称',
  `gender` tinyint(1) UNSIGNED NULL DEFAULT NULL COMMENT '性别',
  `language` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '语言',
  `province` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '省份',
  `country` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '国家',
  `avatar_url` varchar(4096) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '头像',
  `create_time` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `last_visit_time` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT '最后登录时间',
  PRIMARY KEY (`openid`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '用户信息' ROW_FORMAT = Dynamic;
```

``` sql
CREATE TABLE `event`  (
`eventid` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'eventid',
`title` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '标题',
`event_date` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '活动日期',
`event_time` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '活动时间',
`location` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '地点',
`purchase_date` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '抢票日期',
`purchase_time` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '抢票时间',
`tickets_left` int UNSIGNED NULL DEFAULT NULL COMMENT '票余量',
`text` varchar(1024) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '简介',
`img_path` varchar(4096) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT '~/images/default.jpg' COMMENT '图片路径',
`create_time` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
PRIMARY KEY (`eventid`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '活动信息' ROW_FORMAT = Dynamic;
```

``` sql
CREATE TABLE `ticket`  (
`ticketid` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'eventid',
`studentid` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL COMMENT 'studentid',
`validation` tinyint(1) UNSIGNED NULL DEFAULT NULL COMMENT '有效校验',
`eventid` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL COMMENT 'eventid',
`title` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '标题',
`event_date` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '活动日期',
`event_time` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '活动时间',
`location` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '地点',
`create_time` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
PRIMARY KEY (`ticketid`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '门票信息' ROW_FORMAT = Dynamic;
```

设置活动信息和门票中相应活动同步的trigger
``` sql
DELIMITER $
CREATE TRIGGER event_update_trigger AFTER UPDATE
ON event FOR EACH ROW
BEGIN
UPDATE ticket SET title=new.title, event_date=new.event_date, event_time=new.event_time, location=new.location WHERE eventid=old.eventid;
END$
DELIMITER ;
```

活动被删除后触发的trigger，活动删除后相应的ticket中validation字段设为-1
``` sql
DELIMITER $
CREATE TRIGGER event_delete_trigger AFTER DELETE
ON event FOR EACH ROW
BEGIN
UPDATE ticket SET validation=-1 WHERE eventid=old.eventid;
END$
DELIMITER ;
```

创建管理员账户(以账户名:admin，密码:123，为例)
``` sql
INSERT INTO admin (admin_username, admin_password, create_time, last_visit_time) VALUES ('admin', '123', NOW(), NOW());
```

更改管理员账户密码(以账户名:admin，新密码:456，为例)
``` sql
UPDATE admin SET admin_password='456' WHERE admin_username='admin';
```

如果需要彻底删除表（以user为例）：
``` sql
DROP TABLE user;
```

## IDEA配置
在IDEA中用打开`ThuTickets/thutickets`文件夹，右击项目名称选择`maven->Reimport`可以自动导入依赖的包。

### 依赖包可以在pom.xml中查看
依赖包主要有以下（通过以上操作已经安装好）：
Mybatis-Plus（用于将实体类映射到数据库中的数据项）、lombok（用于实体类中简化代码）、MySQL驱动、SpringBoot依赖包等。

### 访问静态资源
请将cn.edu.tsinghua.thutickets.configuration.WebAppConfig中addResourceHandler方法下addResourceLocations改为本机的绝对路径（记得前面必须有"file:"）。

## 运行
在IDEA中找到`src/main/java/cn.edu.tsinghua.thutickets/ThuticketsApplication`，右击该文件点击`run 'ThuticketsApplication'`启动服务器（端口8000，可在`src/main/resources/application.properties`中修改）。
